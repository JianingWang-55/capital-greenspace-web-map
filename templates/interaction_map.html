<!DOCTYPE html>
<!--
  interaction_map.html
  
  Interactive Search Map 

  Purpose:
  - Provides an interactive Leaflet-based map for exploring Edinburgh parks.
  - Enables users to search, filter, rank, and locate parks based on multiple criteria.

  Key Functionalities:
  - Name-based search with autocomplete suggestions.
  - Ranking and filtering by multiple score criteria (recreation, quality, quantity,
    safety, accessibility).
  - Location-based search using Edinburgh postcodes with distance or nearest-only modes.
  - Facility-based filtering (select one or more required facilities).
  - Interactive popups with image galleries, score charts, and routing options.
  - Export of filtered/search results to CSV format.

  UI Components:
  - Sidebar with accordion panels for different search modes.
  - Multiple modal dialogs for user feedback (ties, errors, missing input, no results).
  - Loading overlay and toast notifications for processing/status messages.
  - Responsive layout separating sidebar controls and map display.

  Data & Integration:
  - Uses Flask/Jinja2 to inject backend data:
      * `parks`: park attributes, geometry, scores, images.
      * `facilities`: available facility types for filtering.
  - Relies on Leaflet.js for map rendering and interaction.
  - Modular JavaScript files handle configuration, UI logic, popups, map behavior,
    search, ranking, and proximity analysis.

  Notes:
  - Designed for academic demonstration and user exploration of greenspace
    recreation metrics in Edinburgh.
  - Styling is primarily handled via an external CSS file
    (`static/css/interaction_map.css`).
-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edinburgh Park Finder</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/interaction_map.css') }}">
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 10px; font-weight: bold; color: var(--primary-color);">Processing...</p>
</div>

<div id="toast">Message here</div>

<div class="modal-overlay" id="modal-overlay"></div>

<div id="tie-modal">
    <h3><i class="fa-solid fa-trophy"></i> Rankings Found</h3>
    <p id="tie-modal-note" style="font-size:13px; color:#d35400; margin:0 0 10px 0; font-weight:bold; display:none;"></p>
    <div class="tie-list" id="tie-list-content"></div>
    <button class="close-modal-btn" onclick="closeTieModal()">Close</button>
</div>

<div id="nearby-modal">
    <h3><i class="fa-solid fa-location-arrow"></i> Parks Nearby</h3>
    <div class="tie-list" id="nearby-list-content"></div>
    <button class="close-modal-btn" onclick="closeNearbyModal()">Close</button>
</div>

<div id="no-results-modal">
    <h3><i class="fa-solid fa-circle-exclamation"></i> No Matches Found</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        No parks found with <strong>ALL</strong> selected facilities.
    </div>
    <button class="close-modal-btn" onclick="closeNoResultsModal()">Close</button>
</div>

<div id="invalid-postcode-modal">
    <h3><i class="fa-solid fa-triangle-exclamation"></i> Invalid Postcode</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        Please enter a valid Edinburgh postcode<br>(e.g. <strong>EH1 1LZ</strong>).
    </div>
    <button class="close-modal-btn" onclick="closeInvalidPostcodeModal()">Close</button>
</div>

<div id="enter-postcode-modal">
    <h3><i class="fa-solid fa-keyboard"></i> Postcode Required</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        Please enter a postcode to begin the search.
    </div>
    <button class="close-modal-btn" onclick="closeEnterPostcodeModal()">Close</button>
</div>

<div id="select-facility-modal">
    <h3><i class="fa-solid fa-list-check"></i> Facility Selection</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        Please select at least one facility<br>from the list to begin search.
    </div>
    <button class="close-modal-btn" onclick="closeSelectFacilityModal()">Close</button>
</div>

<div id="select-rank-modal">
    <h3><i class="fa-solid fa-chart-column"></i> Criterion Required</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        Please select a score criterion<br>from the dropdown menu.
    </div>
    <button class="close-modal-btn" onclick="closeSelectRankModal()">Close</button>
</div>

<div id="enter-rank-num-modal">
    <h3><i class="fa-solid fa-hashtag"></i> Number Required</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        Please enter a valid number for the top results<br>you wish to see (e.g. 5).
    </div>
    <button class="close-modal-btn" onclick="closeEnterRankNumModal()">Close</button>
</div>

<div id="no-export-data-modal">
    <h3><i class="fa-solid fa-circle-exclamation"></i> No Data</h3>
    <div style="padding: 15px 0; color: #555; font-size: 15px;">
        No data available to export.<br>
    </div>
    <button class="close-modal-btn" onclick="closeNoExportDataModal()">Close</button>
</div>

<div class="layout-wrapper">

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fa-solid fa-magnifying-glass-location"></i> Interactive Search Map</h2>
            <a href="{{ url_for('user_guide') }}#interactive-search" target="_blank" class="btn-help-header" title="Help / User Guide">
                <i class="fa-solid fa-circle-question"></i>
            </a>
        </div>

        <div class="sidebar-content" id="sidebar-content">

            <div class="btn-reset-wrapper">
                <button class="btn btn-grey-small" onclick="clearAllInputs()">
                    <i class="fa-solid fa-eraser"></i> Reset
                </button>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this, 'search-body')">
                    <span><i class="fa-solid fa-magnifying-glass"></i> Find by Name</span>
                    <i class="fa-solid fa-chevron-down arrow"></i>
                </div>
                <div id="search-body" class="accordion-body">
                    <div style="position: relative;">
                        <input id="search-box" type="text" placeholder="Type park name..." autocomplete="off">
                        <div id="suggestions"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this, 'rank-body')">
                    <span><i class="fa-solid fa-chart-simple"></i> Filter by Score</span>
                    <i class="fa-solid fa-chevron-down arrow"></i>
                </div>
                <div id="rank-body" class="accordion-body">
                    <select id="rank-type">
                        <option value="" disabled selected>Select Score Criterion</option>
                        <option value="recreation_highest">Highest Recreation Score</option>
                        <option value="recreation_lowest">Lowest Recreation Score</option>
                        <option value="quality_highest">Highest Facility Quality</option>
                        <option value="quality_lowest">Lowest Facility Quality</option>
                        <option value="quantity_highest">Highest Quantity & Variety</option>
                        <option value="quantity_lowest">Lowest Quantity & Variety</option>
                        <option value="safety_highest">Highest Safety Score</option>
                        <option value="safety_lowest">Lowest Safety Score</option>
                        <option value="accessibility_highest">Highest Accessibility</option>
                        <option value="accessibility_lowest">Lowest Accessibility</option>
                    </select>

                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-style: italic;">
                        We have 18 parks in total for now
                    </div>

                    <input id="rank-number" type="number" min="1" max="50" placeholder="Top X results (e.g. 5)">
                    <button class="btn btn-primary" onclick="applyRanking()">
                        <i class="fa-solid fa-filter"></i> Apply Filter
                    </button>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this, 'loc-body')">
                    <span><i class="fa-solid fa-location-dot"></i> Find Nearby</span>
                    <i class="fa-solid fa-chevron-down arrow"></i>
                </div>
                <div id="loc-body" class="accordion-body">
                    <input id="postcode-input" type="text" placeholder="Edinburgh Postcode (e.g. EH1 1LZ)">
                    
                    <label style="font-size: 12px; font-weight: bold; color:#666;">Select Facilities:</label>
                    <span class="facility-help-text">Select facilities below (Check all that apply)</span>
                    <div class="facility-list" id="facility-checklist"></div>
                    
                    <label style="font-size: 12px; font-weight: bold; color:#666; margin-top:10px; display:block;">Search Mode:</label>
                    <div class="btn-split-group">
                        <button id="mode-dist" class="btn-split-option active" onclick="setSearchMode(false)">
                            <i class="fa-solid fa-ruler-horizontal"></i> Within Distance
                        </button>
                        <button id="mode-near" class="btn-split-option" onclick="setSearchMode(true)">
                            <i class="fa-solid fa-ruler-vertical"></i> Nearest Only
                        </button>
                    </div>

                    <input id="distance-input" type="number" step="0.1" placeholder="Max Distance (km)" value="5.0">
                    
                    <button class="btn btn-primary" onclick="applyLocationSearch()">
                        <i class="fa-solid fa-search-location"></i> Search Nearby
                    </button>
                </div>
            </div>

        </div>

        <div class="sidebar-footer">
            <button class="btn btn-export" onclick="exportParksToCSV()">
                <i class="fa-solid fa-file-csv"></i> Export Data (CSV)
            </button>
            
            <a href="{{ url_for('index') }}" class="btn btn-grey-small">
                <i class="fa-solid fa-house"></i> Back to Home
            </a>
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
    // =========================
    // DATA FROM FLASK
    // =========================
    const parks = {{ parks | tojson }};
    const facilities = {{ facilities | tojson }};
    const SEARCH_URL = "{{ url_for('search_parks_by_location') }}";
    const STATIC_BASE = "{{ url_for('static', filename='') }}";
</script>

<script>
    window.currentImageIndex = window.currentImageIndex || {};
    window.changeImage = function(parkId, direction) {
        const gallery = document.getElementById('gallery-' + parkId);
        if(!gallery) return;
        const images = gallery.querySelectorAll('.gallery-image');
        const counter = document.getElementById('counter-' + parkId);
        
        if (!currentImageIndex[parkId]) currentImageIndex[parkId] = 0;
        
        images[currentImageIndex[parkId]].classList.remove('active');
        currentImageIndex[parkId] += direction;
        
        if (currentImageIndex[parkId] < 0) currentImageIndex[parkId] = images.length - 1;
        if (currentImageIndex[parkId] >= images.length) currentImageIndex[parkId] = 0;
        
        images[currentImageIndex[parkId]].classList.add('active');
        if (counter) counter.textContent = `${currentImageIndex[parkId] + 1}/${images.length}`;
    };

    function createPopupContent(p, extraBadge = "") {
        let galleryHTML = `<div class="no-image-placeholder" style="height:160px; display:flex; align-items:center; justify-content:center; background:#eee; color:#999; font-size:14px;">No Image</div>`;
        
        if (p.images && p.images.length > 0) {
            let imgs = p.images.map((src, i) => {
                const fullUrl = '/static/' + src.split('/').map(encodeURIComponent).join('/');
                return `<img src="${fullUrl}" class="gallery-image ${i===0?'active':''}" onerror="this.style.display='none'">`;
            }).join('');
            
            let controls = p.images.length > 1 
                ? `<div class="gallery-controls">
                    <span class="gallery-nav" onclick="changeImage(${p.site_id}, -1)">❮</span>
                    <span class="gallery-count" id="counter-${p.site_id}">1/${p.images.length}</span>
                    <span class="gallery-nav" onclick="changeImage(${p.site_id}, 1)">❯</span>
                   </div>` 
                : '';
            galleryHTML = `<div class="image-gallery" id="gallery-${p.site_id}">${imgs}${controls}</div>`;
        }
        
        let chartHTML = `<div class="chart-image-container">
            <img src="/static/barchart/${p.site_id}.svg" class="chart-image" alt="Scores for ${p.name}" 
            onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'text-align:center;color:red;padding:10px;\'>Chart not available</div>'">
        </div>`;

        return `
            <div class="popup-card">
                ${galleryHTML}
                <div class="popup-header"><div class="popup-title">${p.name}</div>${extraBadge}</div>
                <div class="popup-body">
                    <div class="rec-metric">Recreation Metric: ${p.recreation || 'N/A'}</div>
                    ${chartHTML}
                    <div class="meta-info"><strong>Site ID:</strong> ${p.site_id} • <strong>SIMD:</strong> ${p.decile}<br>${p.community}, ${p.postcode}</div>
                    <div class="btn-row"><button onclick="showRoute(${p.lat}, ${p.lon})" class="action-btn btn-route"><i class="fa-solid fa-diamond-turn-right"></i> Route</button></div>
                </div>
            </div>
        `;
    }
</script>

<script src="{{ url_for('static', filename='js/interaction/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/popup.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/search_name.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/ranking.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/nearby.js') }}"></script>
<script src="{{ url_for('static', filename='js/interaction/main.js') }}"></script>

</body>
</html>